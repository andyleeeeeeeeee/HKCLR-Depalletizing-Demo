<?xml version="1.0"?>
<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <Sequence name="Hkcenter Palletizing demo full collision with full collision free">
            <Sequence name="Create planning scene">
                <Action ID="ExecuteAddPlane" group_name="arm" name="Add ground plane to scene" plane_name="ground" plane_normal="0 0 1" plane_pose="0 0 -0.05 0 0 0 1" service_name="execute_add_plane"/>
                <Action ID="ExecuteAddBox" auto_subfix="0" box_name="conveyor" box_pose="1.08 0 0.45 0 0 0 1" box_size="0.69 3 1.03" group_name="arm" is_absolute="1" name="Add conveyor belt collision object" service_name="execute_add_box"/>
                <Action ID="ExecuteAddBox" auto_subfix="0" box_name="pallet_r" box_pose="0 -1.2 -0.05 0 0 0 1" box_size="1.2 0.8 0.2" group_name="arm" is_absolute="1" name="Add pallet for small box" service_name="execute_add_box"/>
                <Action ID="ExecuteAddBox" auto_subfix="0" box_name="pallet_l" box_pose="0 1.2 -0.05 0 0 0 1" box_size="1.2 0.8 0.2" group_name="arm" is_absolute="1" name="Add pallet for large box" service_name="execute_add_box"/>
            </Sequence>
            <Action ID="ExecuteGroupAngularJointStates" goal="0 30 -20 0 -90 0" group_name="arm" name="Go to initial pose" service_name="execute_group_joint_states" tolerance="0.01"/>
            <Repeat num_cycles="72">
                <Sequence name="Process loop">
                    <Sequence name="Sensing">
                        <Action ID="ExecuteLoadObject" name="Load a random box" service_name="execute_load_object" type="0"/>
                        <Action ID="ExecuteConveyorCmd" enable="1" name="Run conveyor" service_name="execute_conveyor_cmd" speed="2.0"/>
                        <ForceSuccess>
                            <KeepRunningUntilFailure>
                                <Inverter>
                                    <Action ID="SenseObjectExist" duration="3" service_name="sense_object_exist"/>
                                </Inverter>
                            </KeepRunningUntilFailure>
                        </ForceSuccess>
                        <Action ID="ExecuteConveyorCmd" enable="0" name="Stop conveyor" service_name="execute_conveyor_cmd" speed="2.0"/>
                        <Action ID="SenseObjectPose" category="{box_category}" name="Get box 6d pose" pose="{box_pose}" service_name="sense_object_pose"/>
                        <Action ID="ExecutePlanning" category="{box_category}" pick_pose="{pick_pose}" place_obj_pose="{place_obj_pose}" place_pose="{place_pose}" pose="{box_pose}" pre_pick_pose="{pre_pick_pose}" pre_place_pose="{pre_place_pose}" service_name="execute_planning"/>
                    </Sequence>
                    <Sequence name="Robot movements">
                        <ForceSuccess>
                            <Action ID="ExecuteGroupPose" constraint="" goal="{pre_pick_pose}" goal_type="0" group_name="arm" name="Go to pre pick pose" service_name="execute_group_pose" tolerance="0.01"/>
                        </ForceSuccess>
                        <ForceSuccess>
                            <Action ID="ExecuteGroupPose" constraint="" goal="{pick_pose}" goal_type="0" group_name="arm" name="Go to pick pose" service_name="execute_group_pose" tolerance="0.01"/>
                        </ForceSuccess>
                        <Action ID="ExecuteSuction" enable="1" name="Pick the box" service_name="execute_suction"/>
                        <Switch2 case_1="0" case_2="1" name="Category switch" variable="{box_category}">
                            <Action ID="ExecuteAttachBox" box_name="large_box" box_pose="{box_pose}" box_size="0.52 0.4 0.2" eef_group_name="gripper" group_name="arm" name="Attach large box to gripper" service_name="execute_attach_box"/>
                            <Action ID="ExecuteAttachBox" box_name="small_box" box_pose="{box_pose}" box_size="0.47 0.3 0.08" eef_group_name="gripper" group_name="arm" name="Attach small box to gripper" service_name="execute_attach_box"/>
                            <AlwaysSuccess/>
                        </Switch2>
                        <ForceSuccess>
                            <Action ID="ExecuteGroupPose" constraint="" goal="{pre_pick_pose}" goal_type="0" group_name="arm" name="Go to pre pick pose" service_name="execute_group_pose" tolerance="0.01"/>
                        </ForceSuccess>
                        <Switch2 case_1="0" case_2="1" name="Middle pose Switch1" variable="{box_category}">
                            <Action ID="ExecuteGroupAngularJointStates" goal="90 50 -20 0 -90 40" group_name="arm" name="Middle pose for left" service_name="execute_group_joint_states" tolerance="0.01"/>
                            <Action ID="ExecuteGroupAngularJointStates" goal="-90 50 -20 0 -90 -40" group_name="arm" name="Middle pose for right" service_name="execute_group_joint_states" tolerance="0.01"/>
                            <AlwaysSuccess/>
                        </Switch2>
                        <ForceSuccess>
                            <Action ID="ExecuteGroupPose" constraint="" goal="{pre_place_pose}" goal_type="0" group_name="arm" name="Go to pre place pose" service_name="execute_group_pose" tolerance="0.04"/>
                        </ForceSuccess>
                        <ForceSuccess>
                            <Action ID="ExecuteGroupPose" constraint="" goal="{place_pose}" goal_type="0" group_name="arm" name="Go to place pose" service_name="execute_group_pose" tolerance="0.04"/>
                        </ForceSuccess>
                        <Action ID="ExecuteSuction" enable="0" name="Release the box" service_name="execute_suction"/>
                        <Switch2 case_1="0" case_2="1" variable="{box_category}">
                            <Sequence>
                                <Action ID="ExecuteDetachObject" group_name="arm" obj_name="large_box" service_name="execute_detach_object"/>
                                <Action ID="ExecuteRemoveObject" is_exact="1" obj_name="large_box" service_name="execute_remove_object"/>
                                <Action ID="ExecuteAddBox" auto_subfix="1" box_name="large_box" box_pose="{place_obj_pose}" box_size="0.52 0.4 0.2" group_name="arm" is_absolute="1" service_name="execute_add_box"/>
                            </Sequence>
                            <Sequence>
                                <Action ID="ExecuteDetachObject" group_name="arm" obj_name="small_box" service_name="execute_detach_object"/>
                                <Action ID="ExecuteRemoveObject" is_exact="1" obj_name="small_box" service_name="execute_remove_object"/>
                                <Action ID="ExecuteAddBox" auto_subfix="1" box_name="small_box" box_pose="{place_obj_pose}" box_size="0.47 0.3 0.08" group_name="arm" is_absolute="1" service_name="execute_add_box"/>
                            </Sequence>
                            <AlwaysSuccess name="Default is success"/>
                        </Switch2>
                        <Switch2 case_1="0" case_2="1" name="Middle pose Switch2" variable="{box_category}">
                            <Action ID="ExecuteGroupAngularJointStates" goal="90 50 -20 0 -90 0" group_name="arm" name="Middle pose for left" service_name="execute_group_joint_states" tolerance="0.01"/>
                            <Action ID="ExecuteGroupAngularJointStates" goal="-90 50 -20 0 -90 0" group_name="arm" name="Middle pose for right" service_name="execute_group_joint_states" tolerance="0.01"/>
                            <AlwaysSuccess/>
                        </Switch2>
                        <ForceSuccess>
                            <Action ID="ExecuteGroupAngularJointStates" goal="0 30 -20 0 -90 0" group_name="arm" name="Go to prepare pose" service_name="execute_group_joint_states" tolerance="0.01"/>
                        </ForceSuccess>
                    </Sequence>
                </Sequence>
            </Repeat>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Action ID="ExecuteAddBox">
            <input_port default="1" name="auto_subfix"/>
            <input_port default="box" name="box_name"/>
            <input_port default="{place_pose}" name="box_pose"/>
            <input_port default="0.2 0.2 0.2" name="box_size"/>
            <input_port default="arm" name="group_name"/>
            <input_port default="1" name="is_absolute"/>
            <input_port default="execute_add_box" name="service_name"/>
        </Action>
        <Action ID="ExecuteAddPlane">
            <input_port default="arm" name="group_name"/>
            <input_port default="ground" name="plane_name"/>
            <input_port default="0 0 1" name="plane_normal"/>
            <input_port default="0 0 0 0 0 0 1" name="plane_pose">Pose</input_port>
            <input_port default="execute_add_plane" name="service_name"/>
        </Action>
        <Action ID="ExecuteAllPlans">
            <input_port default="0 0 0 0 0 0 1" name="all_poses">Poses for each group to visit, seperate with | for different groups</input_port>
            <input_port default="0" name="allow_collision"/>
            <input_port default="panda_arm" name="group_names"/>
            <input_port default="0" name="is_absolute"/>
            <input_port default="execute_all_plans" name="service_name"/>
            <input_port default="1" name="stamps"/>
        </Action>
        <Action ID="ExecuteAllPoses">
            <input_port default="0" name="allow_collision"/>
            <input_port default="0 0 0 0 0 0 1" name="goals">Goals for each group to reach, seperate with ;</input_port>
            <input_port default="panda_arm" name="group_names">Names of groups to control, seperate with space</input_port>
            <input_port default="0" name="is_absolute"/>
            <input_port default="execute_all_poses" name="service_name"/>
            <input_port default="1" name="stamps">Time stamps for each group reaching the goal, seperate with space</input_port>
        </Action>
        <Action ID="ExecuteAttachBox">
            <input_port name="box_name"/>
            <input_port name="box_pose"/>
            <input_port name="box_size"/>
            <input_port default="gripper" name="eef_group_name"/>
            <input_port default="arm" name="group_name"/>
            <input_port default="execute_attach_box" name="service_name"/>
        </Action>
        <Action ID="ExecuteConveyorCmd">
            <input_port default="0" name="enable"/>
            <input_port default="execute_conveyor_cmd" name="service_name"/>
            <input_port default="2.0" name="speed"/>
        </Action>
        <Action ID="ExecuteDetachObject">
            <input_port default="arm" name="group_name"/>
            <input_port name="obj_name"/>
            <input_port default="execute_detach_object" name="service_name"/>
        </Action>
        <Action ID="ExecuteGroupAngularJointStates">
            <input_port default="0 0 0 0 0 0 0" name="goal"/>
            <input_port default="arm" name="group_name"/>
            <input_port default="execute_group_joint_states" name="service_name"/>
            <input_port default="0.01" name="tolerance"/>
        </Action>
        <Action ID="ExecuteGroupLinearJointStates">
            <input_port default="0.04 0.04" name="goal"/>
            <input_port default="hand" name="group_name"/>
            <input_port default="execute_group_joint_states" name="service_name"/>
            <input_port default="0.001" name="tolerance"/>
        </Action>
        <Action ID="ExecuteGroupPlan">
            <input_port default="0" name="allow_collision"/>
            <input_port default="panda_arm" name="group_name"/>
            <input_port default="0" name="is_absolute"/>
            <input_port default="0 0 0.1 0 0 0 1;0 0 -0.1 0 0 0 1" name="poses">Trajectory poses in plan. Each pose is relevant to the last pose.</input_port>
            <input_port default="execute_group_plan" name="service_name"/>
            <input_port default="2" name="stamp">Time stamp of the last pose in plan</input_port>
        </Action>
        <Action ID="ExecuteGroupPose">
            <input_port name="constraint"/>
            <input_port default="0 0 0 0 0 0 1" name="goal"/>
            <input_port default="0" name="goal_type"/>
            <input_port default="arm" name="group_name"/>
            <input_port default="execute_group_pose" name="service_name"/>
            <input_port default="0.01" name="tolerance"/>
        </Action>
        <Action ID="ExecuteGroupPosition">
            <input_port default="0 0 0" name="goal"/>
            <input_port default="arm" name="group_name"/>
            <input_port default="0" name="is_absolute"/>
            <input_port default="execute_group_position" name="service_name"/>
            <input_port default="0.005" name="tolerance"/>
        </Action>
        <Action ID="ExecuteGroupShift">
            <input_port default="z" name="axis">Could be x y z roll pitch yaw</input_port>
            <input_port default="0" name="goal"/>
            <input_port default="arm" name="group_name"/>
            <input_port default="0" name="is_absolute"/>
            <input_port default="execute_group_shift" name="service_name"/>
            <input_port default="0.01" name="tolerance"/>
        </Action>
        <Action ID="ExecuteLoadObject">
            <input_port default="execute_load_object" name="service_name"/>
            <input_port default="0" name="type">&lt;0 unload, 0 load random, &gt;=1 load obj id=type</input_port>
        </Action>
        <Action ID="ExecutePlanning">
            <input_port default="0" name="category">0 for large box, 1 for small box</input_port>
            <output_port name="pick_pose">Pose</output_port>
            <output_port name="place_obj_pose">Pose</output_port>
            <output_port name="place_pose">Pose</output_port>
            <input_port name="pose">Pose</input_port>
            <output_port name="pre_pick_pose">Pose</output_port>
            <output_port name="pre_place_pose">Pose</output_port>
            <input_port default="execute_planning" name="service_name"/>
        </Action>
        <Action ID="ExecuteRemoveObject">
            <input_port default="1" name="is_exact"/>
            <input_port name="obj_name"/>
            <input_port default="execute_remove_object" name="service_name"/>
        </Action>
        <Action ID="ExecuteSuction">
            <input_port default="0" name="enable"/>
            <input_port default="execute_suction" name="service_name"/>
        </Action>
        <Action ID="SenseObjectExist">
            <input_port default="3" name="duration"/>
            <input_port default="sense_object_exist" name="service_name">Success if object exist, fail elsewise</input_port>
        </Action>
        <Action ID="SenseObjectPose">
            <output_port name="category">String, 0 for large box, 1 for small box</output_port>
            <output_port name="pose">Pose</output_port>
            <input_port default="sense_object_pose" name="service_name"/>
        </Action>
    </TreeNodesModel>
    <!-- ////////// -->
</root>

